<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PDF.js mobile</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.228/pdf_viewer.css" rel="stylesheet" integrity="sha256-kL2OHdmSAnGvE1fC/8DCaB/0yvHkLP1u538UiQ5Rgy8=" crossorigin="anonymous" />
    <link href="https://cdn.bootcss.com/Swiper/4.5.0/css/swiper.min.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/pdf.js/2.2.228/pdf_viewer.css" rel="stylesheet">
</head>
<body>
<div class="swiper-container">
    <div id="viewer" class="swiper-wrapper"></div>
</div>
<script src="https://cdn.bootcss.com/vConsole/2.5.2/vconsole.min.js"></script>
<script src="https://cdn.bootcss.com/Swiper/4.5.0/js/swiper.min.js"></script>
<script src="https://cdn.bootcss.com/pdf.js/2.2.228/pdf.worker.min.js"></script>
<script src="https://cdn.bootcss.com/pdf.js/2.2.228/pdf.min.js"></script>
<script src="https://cdn.bootcss.com/pdf.js/2.2.228/pdf_viewer.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/url-search-params/1.1.0/url-search-params.js"></script>
<script src="./main.js"></script>
<script>
    var url = new URLSearchParams(window.location.search).get("src");
    pdfjsLib.getDocument(url).then(function(pdf){
        var viewer = document.getElementById('viewer');
        viewer.innerHTML = '';
        var NUM_PAGES = pdf._pdfInfo.numPages;
        for (var i=0; i<NUM_PAGES; i++) {
            var page = UI.createPage(i+1);
            viewer.appendChild(page);
        }


        UI.renderPage(1,pdf);
        new Swiper ('.swiper-container', {
            touchMoveStopPropagation : false,
            on: {
                slideChange: function () {
                    var visiblePageNum = this.activeIndex+1;
                    var SWIPER_SCALE,DISTANCE = 3;
                    var visiblePage = document.querySelector('.page[data-page-number="'+visiblePageNum+'"][data-loaded="false"]');
                    if (visiblePage) {
                        setTimeout(function () {
                            UI.renderPage(visiblePageNum,pdf,function(){
                                //及时修正swiper错位问题
                                if(!SWIPER_SCALE){
                                    SWIPER_SCALE = UI.getTranslate(document.getElementById('viewer'));
                                }else if(UI.getTranslate(document.getElementById('viewer'))%SWIPER_SCALE !== 0){
                                    document.getElementById('viewer').style.webkitTransform = 'translate3d('+visiblePageNum*SWIPER_SCALE+'px, 0px, 0px)';
                                    document.getElementById('viewer').style.transform = 'translate3d('+visiblePageNum*SWIPER_SCALE+'px, 0px, 0px)'
                                }

                                //及时收回前后DISTANCE页的内存
                                if(visiblePageNum>DISTANCE){
                                    UI.destroyPage(visiblePageNum-DISTANCE);
                                    UI.destroyPage(visiblePageNum+DISTANCE);
                                }
                            });
                        })
                    }
                }
            }
        })
    })
</script>
</body>
</html>
